<!DOCTYPE html>
<html>
<head>
    <title>OpenCV.js WebCam Example</title>
    <script async src="https://docs.opencv.org/master/opencv.js"></script>
</head>
<body>
    <h2>OpenCV.js WebCam Example</h2>
    <canvas id="canvasOutput" width="640" height="480"></canvas>
    <script>
        let video = document.createElement('video');
        let canvas = document.getElementById('canvasOutput');
        let context = canvas.getContext('2d');

        // OpenCV.js 로드 확인
        cv['onRuntimeInitialized']=()=>{
            console.log('OpenCV.js is ready.');
            startCamera();
        };

        // 카메라 시작
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    processVideo();
                })
                .catch(err => {
                    console.error("Error accessing the camera: ", err);
                });
        }

        // 비디오 프레임 처리
        function processVideo() {
            if (video.ended || video.paused) {
                return;
            }

            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);

            context.drawImage(video, 0, 0, video.width, video.height);
            let imageData = context.getImageData(0, 0, video.width, video.height);
            src.data.set(imageData.data);

            // OpenCV 함수를 사용한 이미지 처리
            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);

            cv.imshow("canvasOutput", dst); // 결과 표시
            src.delete(); dst.delete();

            requestAnimationFrame(processVideo);
        }
    </script>
</body>
</html>
