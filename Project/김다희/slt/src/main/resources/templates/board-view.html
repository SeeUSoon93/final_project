<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="/css/css_board/board-view.css">
	<script src="https://kit.fontawesome.com/08f5f8a0fd.js" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

</head>

<body>
	<!--<div id="header-container"></div>-->

	<div class="banner">
		<div class="banner-font">
			<h2>커뮤니티</h2>
			<P>커뮤니티 상세보기</P>
		</div>
	</div>

	<div class="bv-contents">
		<div class="bv-group">
			<form id="viewForm">
				<table class="tableset">
					<div class="board_view_wrap">
						<div class="board_view">
							<div class="title" id="subject">
								<h3 th:text="${tbBoard.bdTitle}"></h3>
							</div>
							<div id="bdIdx" th:text="${tbBoard.bdIdx}"></div>
							<div class="info-group">
								<div class="info">
									<div id="writer" th:text="${tbBoard.tbUser.userNick}"></div>
								</div>
								<div class="info">
									<div id="date" th:text="${#temporals.format(tbBoard.createdAt, 'yyyy-MM-dd')}">
									</div>
								</div>
								<div class="info">
									<div id="views" th:text="${tbBoard.bdViews}">
										<i class="fa-regular fa-eye"></i>
									</div>
								</div>
								<div class="info">
									<div id="like" th:text="${tbBoard.bdLikes}">
										<i class="fa-solid fa-heart"></i>
									</div>
								</div>
								<div class="cont">
									<div id="content" th:text="${tbBoard.bdContent}"></div>
								</div>
								<div class="bt-group">
									<i id="heart" class="fa-regular fa-heart fa-3x"></i>
									<div class="bt_wrap">
										<button id="list" class="view-bt" type="button"
											onclick="location.href='./list.html'">목 록</button>
										<div th:if="${isAuthor}">
											<button id="modify" class="view-bt" onclick="editPost()">수 정</button>
											<button id="delete" class="view-bt" onclick="deletePost()">삭 제</button>
										</div>
									</div>
								</div>
								<!-- 댓글 시스템 시작 -->
								<div class="comments">
									<form id="comment-form">
										<textarea id="comment-text" onkeydown="resize(this)" onkeyup="resize(this)"
											placeholder="댓글을 입력하세요"></textarea>
										<button type="submit">댓글 작성</button>
									</form>
									<div id="comments-container">
									</div>
								</div>
								<!-- 댓글 시스템 끝 -->
							</div>
						</div>
				</table>
			</form>
		</div>
	</div>

	<!--<div id="footer-container"></div>-->

	<script src="/js/js_headfoot/headFoot.js"></script>
	<script>

		function resize(obj) {
			obj.style.height = "1rem";
			obj.style.height = (0.75 + obj.scrollHeight / 16) + "rem";
		}

		// 댓글 추가 함수
		function addComment() {
			var bdIdx = $("#bdIdx").text();
			var comment = $("#comment").val();

			$.ajax({
				type: "Post",
				url: "/comment/create",
				data: {
					bdIdx: bdIdx,
					comment: comment
				},
				contentType: false,
				processData: false,
				success: function (data) {
					updateCommentList(data);
				},
				error: function () {
					alert("댓글 등록에 실패했습니다.");
				}
			});
		}

		// 댓글 목록 업데이트 함수
		function updateCommentList(data) {
			var commentsDiv = $("#comments-container");
			commentsDiv.empty();

			if (data.length > 0) {
				for (var i = 0; i < data.length; i++) {
					var comment = data[i];
					var formattedDate = formatCommentDate(comment.createdAt);
					commentHtml = `
                <div class="comnt-table">
                    <div class="comnt-field">
                        <div class="comnt-header">
                            <div class="comnt-id">${comments.tbUser.userNick}</div>
                            <div class="comnt-date">${formattedDate}</div>
                        </div>
                        <div class="comnt-contents">
                            <div class="comnt-read">${comments.cmtContent}</div>
                        </div>
                    </div>
                </div>
            `;
					commentsDiv.append(commentHtml);
				}
			} else {
				commentsDiv.append("<p>등록된 댓글이 없습니다.</p>");
			}
		}

		function formatCommentDate(dateString) {
			var date = new Date(dateString);
			var now = new Date();
			var diffInMilliseconds = now - date;

			if (diffInMilliseconds < 60 * 60 * 1000) {
				// 1시간 이내
				return Math.floor(diffInMilliseconds / (60 * 1000)) + "분 전";
			} else if (diffInMilliseconds < 24 * 60 * 60 * 1000) {
				// 24시간 이내
				return Math.floor(diffInMilliseconds / (60 * 60 * 1000)) + "시간 전";
			} else {
				// 그 외
				var options = {year: 'numeric', month: '2-digit', day: '2-digit'};
				return date.toLocaleDateString('ko-KR', options);
			}
		}

		// 초기 댓글 목록 불러오기
		$(document).ready(function () {
			var bdIdx = $("#bdIdx").text();
			console.log(bdIdx);
			$.ajax({
				type: "GET",
				url: "/comment/select",
				data: {
					bdIdx: bdIdx
				},
				contentType: false,
				processData: false,
				success: function (data) {
					// 초기 댓글 목록 업데이트
					updateCommentList(data);
				},
				error: function () {
					alert("댓글 목록을 불러오는데 실패했습니다.");
				}
			});
		});

	</script>
</body>

</html>